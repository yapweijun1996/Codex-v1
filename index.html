<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Order OCR</title>
<style>
body{font-family:Arial,sans-serif;margin:1em}
#itemsTable{border-collapse:collapse;width:100%;margin-top:10px}
#itemsTable th,#itemsTable td{border:1px solid #ccc;padding:5px}
#itemsTable input{width:100%;box-sizing:border-box}
pre{background:#f4f4f4;padding:10px}
#loader{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.8);text-align:center;padding-top:40vh;font-size:1.5em}
#loader.show{display:block}
@media(max-width:600px){body{margin:.5em}#itemsTable{font-size:12px}}
</style>
</head>
<body>
<h1>Sales Order</h1>
<div id="loader">Processing...</div>
<div>
<input id="imageInput" type="file" accept="image/*" multiple>
<button id="ocrBtn" type="button">Upload & OCR</button>
</div>
<form id="orderForm" onsubmit="return false;">
<div>
<label>To: <input type="text" id="to"></label>
<label>From: <input type="text" id="from"></label>
</div>
<table id="itemsTable">
<thead><tr><th>Stock Code</th><th>Description</th><th>Remark</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr></thead>
<tbody></tbody>
</table>
<button type="button" onclick="addItemRow()">Add Item</button>
</form>
<pre id="jsonOutput"></pre>
<script src="./script_v1.js"></script>
<script>
let img_compress_yn="y";
let img_max_file_size_for_compress=1*1024*1024; // 1MB

function compressImage(file, quality=0.8){
 return new Promise((resolve,reject)=>{
  const reader=new FileReader();
  reader.onload=ev=>{
   const img=new Image();
   img.onload=()=>{
    const canvas=document.createElement('canvas');
    canvas.width=img.width;
    canvas.height=img.height;
    const ctx=canvas.getContext('2d');
    ctx.drawImage(img,0,0);
    canvas.toBlob(blob=>{
     resolve(new File([blob], file.name, {type:'image/jpeg'}));
    },'image/jpeg',quality);
   };
   img.onerror=reject;
   img.src=ev.target.result;
  };
  reader.onerror=reject;
  reader.readAsDataURL(file);
 });
}

async function compressIfNeeded(file){
 if(img_compress_yn!=='y' || file.size<=img_max_file_size_for_compress) return file;
 let quality=0.9;
 let newFile=file;
 while(newFile.size>img_max_file_size_for_compress && quality>0.1){
  newFile=await compressImage(newFile,quality);
  quality-=0.1;
 }
 return newFile;
}
function addItemRow(item={}){
 const tbody=document.querySelector('#itemsTable tbody');
 const row=document.createElement('tr');
 ['stock_code','desc','remark','qty','unit_price','total'].forEach(key=>{
  const td=document.createElement('td');
  td.innerHTML=`<input type="text" class="${key}" value="${item[key]||''}">`;
  row.appendChild(td);
 });
 tbody.appendChild(row);
}
function populateFormFromJSON(data){
 if(!data) return;
 document.getElementById('to').value=data.to||'';
 document.getElementById('from').value=data.from||'';
 const tbody=document.querySelector('#itemsTable tbody');
 tbody.innerHTML='';
 if(Array.isArray(data.items)) data.items.forEach(addItemRow);
}
function fileToBase64(file){
 return new Promise((resolve,reject)=>{
  const r=new FileReader();
  r.onload=()=>resolve(r.result.split(',')[1]);
  r.onerror=reject;
  r.readAsDataURL(file);
 });
}

// Extract the first JSON object found in the given text
function extractJSON(text){
 const start=text.indexOf('{');
 if(start===-1) throw new Error('No JSON found in response');
 let depth=0;
 for(let i=start;i<text.length;i++){
  if(text[i]==='{') depth++;
  else if(text[i]==='}'){
   depth--;
   if(depth===0) return text.slice(start,i+1);
  }
 }
 throw new Error('Incomplete JSON in response');
}


const prompt = `
Extract sales order fields as JSON with the following structure:

{
  "to": "<Name only>",
  "from": "<Name only>",
  "items": [
    {
      "stock_code": "<string>",
      "desc": "<string>",
      "remark": "<string>",
      "qty": <number>,
      "unit_price": <number>,
      "total": <number>
    }
  ]
}

For each 'item', read the table **column by column only**. 
- Do not cross or mix columns, and do not guess or make up values from other columns.
- If a column or cell is missing or blank, output "" (empty string) or null for that field in the JSON.

For 'qty', 'unit_price', and 'total': 
- Remove any commas in the numbers. 
- Output as integer or decimal only, not as a string.

**Example:**
If a row is:
2 | BATTERY | BATTERY |         | 100 | UNIT | 29.00 | 2,900.00

Output:
{
  "stock_code": "BATTERY",
  "desc": "BATTERY",
  "remark": "",
  "qty": 100,
  "unit_price": 29.00,
  "total": 2900.00
}

Return ONLY the JSON object in your response.
If you are not sure about a value or if a value is missing, leave it as "" or null.
`;

async function sendOCR(file) {
  if (!apiKey) {
    alert('Please provide API key');
    throw new Error('No API key');
  }

  let base64;
  try {
    base64 = await fileToBase64(file);
    console.log('Base64 length:', base64.length);
  } catch (err) {
    console.error('Failed to convert file to Base64', err);
    alert('File conversion error');
    throw err;
  }



  const body = {
    contents: [
      {
        role: 'user',
        parts: [
          {
            text: prompt
          },
          {
            inline_data: { data: base64, mime_type: file.type }
          }
        ]
      }
    ],
    generationConfig: {
      temperature: 0.3,
      maxOutputTokens: 8192,
      topP: 0.95,
      responseMimeType: "text/plain"
    }
  };

  console.log('Request body:', body);

  let res;
  try {
    res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemma-3-27b-it:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      }
    );
    console.log('Fetch response:', res);
  } catch (err) {
    console.error('Fetch failed:', err);
    alert('API fetch failed');
    throw err;
  }

  if (!res.ok) {
    const errorText = await res.text();
    console.error('API error', res.status, errorText);
    alert(`API error: ${res.status}`);
    throw new Error(`API error ${res.status}: ${errorText}`);
  }

  let data;
  try {
    data = await res.json();
    console.log('Raw API JSON:', data);
  } catch (err) {
    console.error('Failed to parse API response as JSON:', err);
    alert('Response parsing error');
    throw err;
  }

  // Defensive: check for candidates and content parts
  const candidate = data?.candidates?.[0];
  if (!candidate?.content?.parts) {
    console.error('No candidates or content parts in API response', data);
    alert('Invalid API response: no data');
    throw new Error('Invalid API response: missing candidates');
  }

  const llmText = candidate.content.parts.map(p => p.text || '').join('');
  console.log('LLM response:', llmText);

  // Try to extract JSON from LLM response
  let jsonText;
  try {
    jsonText = extractJSON(llmText);
    console.log('Extracted JSON:', jsonText);
  } catch (err) {
    console.error('JSON extraction failed', err, 'LLM text:', llmText);
    alert('Failed to extract JSON');
    throw err;
  }

  let jsonObj;
  try {
    jsonObj = JSON.parse(jsonText);
    console.log('Parsed JSON:', jsonObj);
  } catch (err) {
    console.error('JSON.parse failed:', err, 'Extracted:', jsonText);
    alert('Failed to parse JSON');
    throw err;
  }

  return jsonObj;
}

async function runOCR(){
 const loader=document.getElementById('loader');
 loader.classList.add('show');
 try{
  const files=document.getElementById('imageInput').files;
  let combined={to:'',from:'',items:[]};
  for(const f of files){
   try{
    const file=await compressIfNeeded(f);
    const json=await sendOCR(file);
    if(json.to) combined.to=json.to;
    if(json.from) combined.from=json.from;
    if(Array.isArray(json.items)) combined.items.push(...json.items);
   }catch(err){
    alert(err.message);
   }
  }
   // Results should already be sanitized by the language model
  document.getElementById('jsonOutput').textContent=JSON.stringify(combined,null,2);
  populateFormFromJSON(combined);
 }finally{
  loader.classList.remove('show');
 }
}
document.getElementById('ocrBtn').addEventListener('click',runOCR);
addItemRow();
</script>
</body>
</html>
