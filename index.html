<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Sales Order OCR</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
#itemsTable { border-collapse: collapse; width: 100%; margin-top: 10px; }
#itemsTable th, #itemsTable td { border: 1px solid #ccc; padding: 5px; }
#itemsTable input { width: 100%; box-sizing: border-box; }
pre { background: #f4f4f4; padding: 10px; }
</style>
</head>
<body>
<h1>Sales Order</h1>
<div>
<input id="imageInput" type="file" accept="image/*" multiple>
<button id="ocrBtn" type="button">Upload & OCR</button>
</div>
<form id="orderForm" onsubmit="return false;">
<div>
<label>To: <input type="text" id="to"></label>
<label>From: <input type="text" id="from"></label>
</div>
<table id="itemsTable">
<thead><tr><th>Stock Code</th><th>Description</th><th>Remark</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr></thead>
<tbody></tbody>
</table>
<button type="button" onclick="addItemRow()">Add Item</button>
</form>
<pre id="jsonOutput"></pre>
<script src="./script_v1.js"></script>
<script>
let img_compress_yn="y";
let img_max_file_size_for_compress=1*1024*1024; // 1MB

function compressImage(file, quality=0.8){
 return new Promise((resolve,reject)=>{
  const reader=new FileReader();
  reader.onload=ev=>{
   const img=new Image();
   img.onload=()=>{
    const canvas=document.createElement('canvas');
    canvas.width=img.width;
    canvas.height=img.height;
    const ctx=canvas.getContext('2d');
    ctx.drawImage(img,0,0);
    canvas.toBlob(blob=>{
     resolve(new File([blob], file.name, {type:'image/jpeg'}));
    },'image/jpeg',quality);
   };
   img.onerror=reject;
   img.src=ev.target.result;
  };
  reader.onerror=reject;
  reader.readAsDataURL(file);
 });
}

async function compressIfNeeded(file){
 if(img_compress_yn!=='y' || file.size<=img_max_file_size_for_compress) return file;
 let quality=0.9;
 let newFile=file;
 while(newFile.size>img_max_file_size_for_compress && quality>0.1){
  newFile=await compressImage(newFile,quality);
  quality-=0.1;
 }
 return newFile;
}
function addItemRow(item={}){
 const tbody=document.querySelector('#itemsTable tbody');
 const row=document.createElement('tr');
 ['stock_code','desc','remark','qty','unit_price','total'].forEach(key=>{
  const td=document.createElement('td');
  td.innerHTML=`<input type="text" class="${key}" value="${item[key]||''}">`;
  row.appendChild(td);
 });
 tbody.appendChild(row);
}
function populateFormFromJSON(data){
 if(!data) return;
 document.getElementById('to').value=data.to||'';
 document.getElementById('from').value=data.from||'';
 const tbody=document.querySelector('#itemsTable tbody');
 tbody.innerHTML='';
 if(Array.isArray(data.items)) data.items.forEach(addItemRow);
}
function fileToBase64(file){
 return new Promise((resolve,reject)=>{
  const r=new FileReader();
  r.onload=()=>resolve(r.result.split(',')[1]);
  r.onerror=reject;
  r.readAsDataURL(file);
 });
}

// Extract the first JSON object found in the given text
function extractJSON(text){
 const start=text.indexOf('{');
 if(start===-1) throw new Error('No JSON found in response');
 let depth=0;
 for(let i=start;i<text.length;i++){
  if(text[i]==='{') depth++;
  else if(text[i]==='}'){
   depth--;
   if(depth===0) return text.slice(start,i+1);
  }
 }
 throw new Error('Incomplete JSON in response');
}

function sanitizeData(data){
 if(!data) return data;
 if(data.to) data.to=data.to.replace(/[^A-Za-z\s]/g,'').trim();
 if(data.from) data.from=data.from.replace(/[^A-Za-z\s]/g,'').trim();
 if(Array.isArray(data.items)){
  data.items=data.items.map(item=>{
   ['qty','unit_price','total'].forEach(field=>{
    if(item[field]&&typeof item[field]==='string'&&item[field].includes(',')){
     delete item[field];
    }
   });
   return item;
  });
 }
 return data;
}
async function sendOCR(file){
 if(!apiKey){alert('Please provide API key'); throw new Error('No API key');}
 const base64=await fileToBase64(file);
 console.log('Base64 length:', base64.length);
 const body={
  contents:[{role:'user',parts:[{text:"Extract sales order fields as JSON with keys 'to','from','items' (array of objects with 'stock_code','desc','remark','qty','unit_price','total'). Return only JSON."},{inline_data:{data:base64,mime_type:file.type}}]}],
  generationConfig:{temperature:0}
 };
 
 
 console.log('Request body:', body);
 //const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
 const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemma-3-27b-it:generateContent?key=${apiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
 console.log('Fetch response:', res);
 if(!res.ok) throw new Error('API error '+res.status);
 const data=await res.json();
 console.log('Raw API JSON:', data);
 const text=data.candidates[0].content.parts.map(p=>p.text).join('');
 console.log('LLM response:', text);
const objText=extractJSON(text);
console.log('Extracted JSON:', objText);
 const json=JSON.parse(objText);
 console.log('Parsed JSON:', json);
 return sanitizeData(json);
}
async function runOCR(){
 const files=document.getElementById('imageInput').files;
 let combined={to:'',from:'',items:[]};
 for(const f of files){
  try{
   const file=await compressIfNeeded(f);
   const json=await sendOCR(file);
   if(json.to) combined.to=json.to;
   if(json.from) combined.from=json.from;
   if(Array.isArray(json.items)) combined.items.push(...json.items);
 }catch(err){
  alert(err.message);
 }
}
 combined=sanitizeData(combined);
 document.getElementById('jsonOutput').textContent=JSON.stringify(combined,null,2);
 populateFormFromJSON(combined);
}
document.getElementById('ocrBtn').addEventListener('click',runOCR);
addItemRow();
</script>
</body>
</html>
